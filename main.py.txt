import os
import telebot
import openai
import tempfile
import matplotlib.pyplot as plt
from io import BytesIO
from groq import Groq
from telegram import Update, InputMediaPhoto
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes, filters

# -------------------------------
# ูุฑุงุกุฉ ุงูููุงุชูุญ ูู Environment Variables
# -------------------------------
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY")
GROQ_API_KEY = os.environ.get("GROQ_API_KEY")

bot = telebot.TeleBot(TELEGRAM_TOKEN)
openai.api_key = OPENAI_API_KEY
client = Groq(api_key=GROQ_API_KEY)

# -------------------------------
# ุฑุณุงูุฉ ุงูุจุฏุงูุฉ
# -------------------------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ุงูุจูุช ุฌุงูุฒ ๐ฅ ุฃุฑุณู ุฃู ุฑุณุงูุฉ ุตูุชูุฉ ุฃู ูุตูุฉ!")

# -------------------------------
# ุงูุชุนุงูู ูุน ุงูุตูุช
# -------------------------------
@bot.message_handler(content_types=['voice'])
def handle_voice(message):
    try:
        file_info = bot.get_file(message.voice.file_id)
        file_path = file_info.file_path
        downloaded = bot.download_file(file_path)
        with tempfile.NamedTemporaryFile(delete=False, suffix=".ogg") as f:
            f.write(downloaded)
            temp_path = f.name

        # ุชุญููู ุงูุตูุช ุฅูู ูุต ุจุงุณุชุฎุฏุงู Whisper
        audio_file = open(temp_path, "rb")
        transcript = openai.audio.transcriptions.create(
            model="gpt-4o-mini-tts",
            file=audio_file
        )

        text = transcript.text or "ูู ูุชู ุงุณุชุฎุฑุงุฌ ูุต ูุงุถุญ."
        
        # -------------------------------
        # ุชุญููู ุงูุตูุช ูุงููุจุฑุฉ ุนุจุฑ Groq
        # -------------------------------
        groq_reply = client.chat.completions.create(
            model="llama3-70b-8192",
            messages=[{"role": "user", "content": text}]
        )
        bot_answer = groq_reply.choices[0].message["content"]

        # -------------------------------
        # ุชูููุฏ ุงูุฑุณูู ุงูุจูุงููุฉ
        # -------------------------------
        # ูุซุงู: ุชูุซูู ุงูุทุงูุฉ ููุงุจู ุงูุชูุชุฑ
        energy = 0.00029
        rhythm = 104.2
        pitch = 1870.7
        tension = min(max(int(energy*1e5), 0), 100)

        plt.figure(figsize=(4,2))
        plt.bar(["ุชูุชุฑ", "ุทุงูุฉ"], [tension, energy*1e5], color=["red", "green"])
        plt.title("๐ ุชุญููู ุงูุตูุช")
        buf = BytesIO()
        plt.savefig(buf, format='png')
        buf.seek(0)
        plt.close()

        # -------------------------------
        # ูุตุงุฆุญ ุงุญุชุฑุงููุฉ ุญุณุจ ุงูุญุงูุฉ
        # -------------------------------
        if tension > 60:
            advice = "โ๏ธ ูุณุชูู ุงูุชูุชุฑ ูุฑุชูุน! ุญุงูู ุงูุชููุณ ุงูุนููู ูุงูุงุณุชุฑุงุญุฉ ุงููุตูุฑุฉ ููุญูุงุธ ุนูู ุงูุชุฑููุฒ."
        elif energy*1e5 < 20:
            advice = "๐ค ุงูุทุงูุฉ ููุฎูุถุฉ. ุฎุฐ ูุณุทูุง ูู ุงูุฑุงุญุฉ ุฃู ูุงุฑุณ ูุดุงุทูุง ุจุณูุทูุง ูุชูุดูุท ุฌุณูู."
        else:
            advice = "โ ุงูุญุงูุฉ ูุชูุงุฒูุฉ. ุญุงูุธ ุนูู ููุท ุงูููู ูุงููุดุงุท ุงููููู."

        # -------------------------------
        # ุฅุฑุณุงู ุงูุชูุฑูุฑ ูููุณุชุฎุฏู
        # -------------------------------
        bot.send_photo(
            message.chat.id,
            photo=buf,
            caption=f"๐ง **ุชุญููู ุงูุตูุช:**\n\n"
                    f"*ุงููุต:* {text}\n"
                    f"*ุงูููุฎุต:* {bot_answer}\n"
                    f"*ูุตูุญุฉ:* {advice}",
            parse_mode="Markdown"
        )

    except Exception as e:
        bot.send_message(message.chat.id, "โ๏ธ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุตูุช.")
        print("Error:", e)

# -------------------------------
# ุจุฏุก ุงูุจูุช
# -------------------------------
bot.polling(none_stop=True)
