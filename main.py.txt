import os
import telebot
import openai
import tempfile
from telebot.types import Message

# -------------------------------
# Read Tokens from Environment
# -------------------------------
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

bot = telebot.TeleBot(TELEGRAM_TOKEN)
openai.api_key = OPENAI_API_KEY


# -------------------------------------
# 1) Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØµÙˆØª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† ØªÙ„ÙŠØ¬Ø±Ø§Ù…
# -------------------------------------
@bot.message_handler(content_types=['voice'])
def handle_voice(message: Message):
    try:
        file_info = bot.get_file(message.voice.file_id)
        file_path = file_info.file_path

        # ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ØµÙˆØª Ù…Ø¤Ù‚ØªÙ‹Ø§
        downloaded = bot.download_file(file_path)
        with tempfile.NamedTemporaryFile(delete=False, suffix=".ogg") as f:
            f.write(downloaded)
            temp_path = f.name

        # -----------------------------
        # 2) ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØª Ù„Ù†Øµ (Whisper)
        # -----------------------------
        audio_file = open(temp_path, "rb")
        transcript = openai.audio.transcriptions.create(
            model="gpt-4o-mini-tts",
            file=audio_file
        )

        text = transcript.text

        # -----------------------------
        # 3) ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ + Ø§Ù„Ù†Ø¨Ø±Ø©
        # -----------------------------
        analysis_prompt = f"""
        Ù‚Ù… Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ù†Ø¨Ø±Ø© ÙˆØ§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ:

        Ø§Ù„Ù†Øµ: {text}

        Ø£Ø±ÙŠØ¯:
        â€¢ Ø¯Ø±Ø¬Ø© Ø§Ù„ØªÙˆØªØ± (0-100)
        â€¢ Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„Ù†ÙØ³ÙŠØ©
        â€¢ Ù…Ù„Ø§Ù…Ø­ Ø§Ù„Ø§Ù†ÙØ¹Ø§Ù„
        â€¢ Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø§Ù„Ø©
        â€¢ Ù†ØµÙŠØ­Ø© Ù‚ØµÙŠØ±Ø©
        """

        gpt_resp = openai.chat.completions.create(
            model="gpt-4.1",
            messages=[
                {"role": "system", "content": "Ø£Ù†Øª Ù…Ø­Ù„Ù„ ØµÙˆØª ÙˆÙ†Ø¨Ø±Ø© Ù…Ø­ØªØ±Ù Ø¬Ø¯Ø§Ù‹."},
                {"role": "user", "content": analysis_prompt},
            ]
        )

        result = gpt_resp.choices[0].message['content']

        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        bot.send_message(message.chat.id, f"ğŸ§ **ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØª:**\n\n{result}", parse_mode="Markdown")

    except Exception as e:
        bot.send_message(message.chat.id, "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØª.")
        print("Error:", e)


# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
bot.polling(none_stop=True)